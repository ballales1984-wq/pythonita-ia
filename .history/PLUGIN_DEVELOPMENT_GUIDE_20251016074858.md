# 🔌 Pythonita Plugin Development Guide

## Guida completa per creare plugin per Pythonita IA

---

## 📚 Indice

1. [Introduzione](#introduzione)
2. [Quick Start](#quick-start)
3. [API Reference](#api-reference)
4. [Esempi Pratici](#esempi-pratici)
5. [Best Practices](#best-practices)
6. [Distribuzione](#distribuzione)

---

## Introduzione

Il sistema di plugin di Pythonita permette di estendere le funzionalità del programma senza modificare il codice sorgente.

### Cosa puoi fare con i plugin:

✅ Aggiungere nuovi comandi custom  
✅ Creare oggetti 3D personalizzati  
✅ Modificare il comportamento di parsing  
✅ Processare codice generato  
✅ Aggiungere template custom  

---

## Quick Start

### 1. Crea il tuo primo plugin

```python
# my_first_plugin.py

from pythonita.plugins import Plugin, PluginInfo

class MyFirstPlugin(Plugin):
    def get_info(self) -> PluginInfo:
        return PluginInfo(
            name="MyFirstPlugin",
            version="1.0.0",
            author="Il Tuo Nome",
            description="Il mio primo plugin!"
        )
    
    def initialize(self, context):
        print("Plugin inizializzato!")
        self.context = context
    
    def shutdown(self):
        print("Plugin chiuso!")
    
    def register_commands(self):
        return {
            'saluta': self._comando_saluta
        }
    
    def _comando_saluta(self, nome="Mondo"):
        return f'print("Ciao, {nome}!")'
```

### 2. Installa il plugin

Copia il file in `~/.pythonita/plugins/my_first_plugin.py`

### 3. Usa il plugin

Avvia Pythonita → il plugin verrà caricato automaticamente!

Ora puoi usare il comando "saluta" nell'interfaccia.

---

## API Reference

### Classe Base `Plugin`

Tutti i plugin devono ereditare da `Plugin` e implementare i metodi astratti.

#### Metodi Obbligatori

##### `get_info() -> PluginInfo`

Ritorna informazioni sul plugin.

```python
def get_info(self) -> PluginInfo:
    return PluginInfo(
        name="NomePlugin",
        version="1.0.0",
        author="Tuo Nome",
        description="Descrizione plugin",
        homepage="https://example.com",  # Opzionale
        license="MIT",  # Opzionale
        dependencies=["numpy", "requests"]  # Opzionale
    )
```

##### `initialize(context: Dict[str, Any])`

Chiamato quando il plugin viene caricato.

**Parametri:**
- `context`: Dizionario con riferimenti ai componenti di Pythonita:
  - `code_generator`: Generatore di codice
  - `command_registry`: Registro comandi
  - `license_manager`: Gestore licenze
  - Altri componenti...

```python
def initialize(self, context):
    self.context = context
    self.my_data = {}
    print("Plugin inizializzato!")
```

##### `shutdown()`

Chiamato quando il plugin viene scaricato o l'applicazione chiusa.

```python
def shutdown(self):
    # Libera risorse
    self.my_data.clear()
    print("Plugin chiuso!")
```

#### Metodi Opzionali (Hooks)

##### `on_command_parsed(command: str, parsed_data: Dict) -> Optional[Dict]`

Hook chiamato dopo il parsing di un comando.

**Uso:** Modificare o arricchire i dati parsati.

```python
def on_command_parsed(self, command: str, parsed_data: dict):
    # Aggiungi metadata
    parsed_data['timestamp'] = datetime.now()
    parsed_data['plugin_processed'] = True
    return parsed_data
```

##### `on_code_generated(code: str, metadata: Dict) -> Optional[str]`

Hook chiamato dopo la generazione del codice.

**Uso:** Modificare o processare il codice generato.

```python
def on_code_generated(self, code: str, metadata: dict):
    # Aggiungi header
    header = "#!/usr/bin/env python3\n# Generated by MyPlugin\n\n"
    return header + code
```

##### `register_commands() -> Dict[str, Callable]`

Registra nuovi comandi custom.

**Returns:** `Dict[nome_comando, funzione_handler]`

```python
def register_commands(self):
    return {
        'comando1': self._handler_comando1,
        'comando2': self._handler_comando2,
    }

def _handler_comando1(self, **kwargs):
    # Implementazione comando
    return "print('Comando eseguito!')"
```

##### `register_3d_objects() -> Dict[str, type]`

Registra nuovi oggetti 3D custom.

**Returns:** `Dict[nome_oggetto, classe_oggetto]`

```python
def register_3d_objects(self):
    return {
        'piramide': PiramideCustom,
        'cubo_magico': CuboMagicoCustom,
    }

class PiramideCustom:
    def __init__(self, posizione=(0, 15, 0)):
        self.nome = "Piramide"
        self.posizione = posizione
        self.colore = (1.0, 0.84, 0.0)
    
    def get_mesh(self):
        # Genera mesh 3D
        # Ritorna (x, y, z) arrays
        pass
```

##### `register_templates() -> Dict[str, str]`

Registra template di codice custom.

**Returns:** `Dict[nome_template, stringa_template]`

```python
def register_templates(self):
    return {
        'loop_avanzato': '''
for i in range({start}, {end}, {step}):
    print(f"Valore: {{i}}")
''',
        'saluto': 'print("Ciao, {nome}!")',
    }
```

---

## Esempi Pratici

### Esempio 1: Plugin Matematica Avanzata

```python
from pythonita.plugins import Plugin, PluginInfo
import math

class MathPlugin(Plugin):
    def get_info(self):
        return PluginInfo(
            name="MathPlugin",
            version="1.0.0",
            author="Math Team",
            description="Funzioni matematiche avanzate"
        )
    
    def initialize(self, context):
        self.context = context
    
    def shutdown(self):
        pass
    
    def register_commands(self):
        return {
            'calcola_fattoriale': self._fattoriale,
            'sequenza_primi': self._primi,
            'calcola_area_cerchio': self._area_cerchio,
        }
    
    def _fattoriale(self, n=5):
        return f'''
import math
n = {n}
result = math.factorial(n)
print(f"Fattoriale di {{n}}: {{result}}")
'''
    
    def _primi(self, limite=100):
        return f'''
def is_prime(n):
    if n < 2:
        return False
    for i in range(2, int(n**0.5) + 1):
        if n % i == 0:
            return False
    return True

primes = [n for n in range(2, {limite}) if is_prime(n)]
print(f"Numeri primi fino a {limite}: {{primes}}")
'''
    
    def _area_cerchio(self, raggio=5):
        return f'''
import math
raggio = {raggio}
area = math.pi * raggio ** 2
print(f"Area cerchio (r={{raggio}}): {{area:.2f}}")
'''
```

### Esempio 2: Plugin Logger

```python
from pythonita.plugins import Plugin, PluginInfo
from datetime import datetime
from pathlib import Path

class LoggerPlugin(Plugin):
    def get_info(self):
        return PluginInfo(
            name="LoggerPlugin",
            version="1.0.0",
            author="Logger Team",
            description="Logga tutti i comandi eseguiti"
        )
    
    def initialize(self, context):
        self.context = context
        self.log_file = Path.home() / ".pythonita" / "command_log.txt"
        self.log_file.parent.mkdir(parents=True, exist_ok=True)
    
    def shutdown(self):
        self._log("Plugin chiuso")
    
    def on_command_parsed(self, command: str, parsed_data: dict):
        self._log(f"Comando: {command}")
        return parsed_data
    
    def on_code_generated(self, code: str, metadata: dict):
        self._log(f"Codice generato: {len(code)} caratteri")
        return code
    
    def _log(self, message: str):
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        with open(self.log_file, 'a', encoding='utf-8') as f:
            f.write(f"[{timestamp}] {message}\n")
```

### Esempio 3: Plugin Oggetti 3D Geometrici

```python
from pythonita.plugins import Plugin, PluginInfo
import numpy as np

class GeometryPlugin(Plugin):
    def get_info(self):
        return PluginInfo(
            name="GeometryPlugin",
            version="1.0.0",
            author="3D Team",
            description="Oggetti 3D geometrici avanzati"
        )
    
    def initialize(self, context):
        self.context = context
    
    def shutdown(self):
        pass
    
    def register_3d_objects(self):
        return {
            'cilindro': Cilindro,
            'cono': Cono,
            'toro': Toro,
        }


class Cilindro:
    def __init__(self, posizione=(0, 15, 0)):
        self.nome = "Cilindro"
        self.posizione = posizione
        self.raggio = 3.0
        self.altezza = 8.0
        self.colore = (0.5, 0.5, 1.0)
    
    def get_mesh(self):
        u = np.linspace(0, 2 * np.pi, 20)
        h = np.linspace(0, self.altezza, 20)
        U, H = np.meshgrid(u, h)
        
        x = self.raggio * np.cos(U) + self.posizione[0]
        y = H + self.posizione[1]
        z = self.raggio * np.sin(U) + self.posizione[2]
        
        return x, y, z


class Cono:
    def __init__(self, posizione=(0, 15, 0)):
        self.nome = "Cono"
        self.posizione = posizione
        self.raggio_base = 5.0
        self.altezza = 10.0
        self.colore = (1.0, 0.5, 0.0)
    
    def get_mesh(self):
        u = np.linspace(0, 2 * np.pi, 20)
        h = np.linspace(0, self.altezza, 20)
        U, H = np.meshgrid(u, h)
        
        r = self.raggio_base * (1 - H / self.altezza)
        
        x = r * np.cos(U) + self.posizione[0]
        y = H + self.posizione[1]
        z = r * np.sin(U) + self.posizione[2]
        
        return x, y, z


class Toro:
    def __init__(self, posizione=(0, 15, 0)):
        self.nome = "Toro"
        self.posizione = posizione
        self.r_maggiore = 5.0
        self.r_minore = 2.0
        self.colore = (1.0, 0.0, 1.0)
    
    def get_mesh(self):
        u = np.linspace(0, 2 * np.pi, 30)
        v = np.linspace(0, 2 * np.pi, 30)
        U, V = np.meshgrid(u, v)
        
        x = (self.r_maggiore + self.r_minore * np.cos(V)) * np.cos(U) + self.posizione[0]
        y = self.r_minore * np.sin(V) + self.posizione[1]
        z = (self.r_maggiore + self.r_minore * np.cos(V)) * np.sin(U) + self.posizione[2]
        
        return x, y, z
```

---

## Best Practices

### 1. Gestione Errori

Sempre usa try-except per gestire errori gracefully:

```python
def initialize(self, context):
    try:
        self.context = context
        self.setup_resources()
    except Exception as e:
        print(f"Errore inizializzazione: {e}")
        # Non bloccare il caricamento
```

### 2. Logging

Usa il logging invece di print per debugging:

```python
import logging

logger = logging.getLogger(__name__)

def initialize(self, context):
    logger.info("Plugin inizializzato")
    logger.debug(f"Context keys: {list(context.keys())}")
```

### 3. Dipendenze

Specifica sempre le dipendenze nel PluginInfo:

```python
def get_info(self):
    return PluginInfo(
        name="MyPlugin",
        version="1.0.0",
        author="Me",
        description="...",
        dependencies=["numpy", "matplotlib", "requests"]
    )
```

### 4. Performance

Non eseguire operazioni pesanti in `initialize()`:

```python
# ❌ BAD
def initialize(self, context):
    self.data = self.load_huge_dataset()  # Lento!

# ✅ GOOD
def initialize(self, context):
    self.data = None  # Lazy loading

def _get_data(self):
    if self.data is None:
        self.data = self.load_huge_dataset()
    return self.data
```

### 5. Pulizia Risorse

Sempre libera risorse in `shutdown()`:

```python
def shutdown(self):
    # Chiudi file aperti
    if self.log_file:
        self.log_file.close()
    
    # Libera memoria
    self.cache.clear()
    
    # Disconnetti connessioni
    if self.connection:
        self.connection.close()
```

---

## Distribuzione

### Come distribuire il tuo plugin

#### 1. Crea un repository GitHub

```bash
my-pythonita-plugin/
├── README.md
├── plugin.py
├── requirements.txt
├── LICENSE
└── examples/
    └── usage_example.py
```

#### 2. Scrivi documentazione

Nel README.md includi:
- Descrizione funzionalità
- Istruzioni installazione
- Esempi uso
- Requisiti

#### 3. Pubblica su PyPI (opzionale)

```bash
# setup.py
from setuptools import setup

setup(
    name="pythonita-plugin-myname",
    version="1.0.0",
    py_modules=["plugin"],
    install_requires=["pythonita-ia"],
)
```

#### 4. Distribuzione manuale

Utenti possono installare copiando il file in `~/.pythonita/plugins/`

---

## Supporto

- **GitHub Issues**: [pythonita-ia/issues](https://github.com/ballales1984-wq/pythonita-ia/issues)
- **Discord**: [Community Discord](#)
- **Email**: support@pythonita.io

---

## Licenza Plugin

I plugin possono avere qualsiasi licenza (MIT, GPL, Proprietary, etc).

Specifica sempre la licenza nel `PluginInfo`:

```python
PluginInfo(
    name="MyPlugin",
    version="1.0.0",
    author="Me",
    description="...",
    license="MIT"  # o "GPL-3.0", "Proprietary", etc.
)
```

---

## Esempi nella Repository

Vedi `examples/example_plugin.py` per un esempio completo funzionante.

---

**Happy Plugin Development! 🚀**


